title: OMSimulator

description:
  This scenario uses oslo.messaging simulator tool to execute MQ test plan.

setup:
  -
    hosts: $target
    tasks:
    - apt: name=git
      become: yes
    - name: installing omsimulator
      git: repo=git://git.openstack.org/openstack/oslo.messaging
           dest=/tmp/performa/oslo.messaging
    - command: git fetch https://review.openstack.org/openstack/oslo.messaging refs/changes/91/291191/2
      args:
        chdir: /tmp/performa/oslo.messaging
    - command: git checkout FETCH_HEAD
      args:
        chdir: /tmp/performa/oslo.messaging
    - apt: name=atop
      become: yes
    - apt: name=daemon
      become: yes

execution:
  -
    hosts: $target
    tasks:
    - atop: command=start
  -
    hosts: $target
    matrix:
      threads: [ 1, 2, 5, 10, 25, 50, 100 ]
    tasks:
    - omsimulator:
        mode: call
        duration: 10
        url: "rabbit://stackrabbit:swordfish@localhost:5672/"
  -
    hosts: $target
    tasks:
    - atop:
        command: stop
        labels: [ CPU, PRC, PRM ]

aggregation:
  -
    update:
      query:
        { task: omsimulator }
      values:
        pipeline:
        - { $match: { task: atop, status: OK, label: PRC, name: beam.smp }}
        - { $group: { _id: null, rabbit_sys: { $avg: "$sys" }, rabbit_user: { $avg: "$user" }, rabbit_total: { $avg: { $add: [ "$sys", "$user" ] }} }}

report:
  template: omsimulator.rst
