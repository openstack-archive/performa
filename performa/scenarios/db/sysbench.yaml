title: Sysbench DB

description:
  This scenario uses sysbench to execute DB test plan.

setup:
  -
    hosts: $target
    tasks:
    - name: installing sysbench
      apt: name=sysbench
      become: yes
    - name: installing atop
      apt:
        name: atop, daemon
      become: yes
  -
    hosts: $target
    tasks:
    - atop: command=start

execution:
  -
    hosts: $target
    matrix:
      threads: [ 10, 20, 30, 40, 50, 60 ]
    tasks:
    - sysbench_oltp:
        duration: 10
  -
    hosts: $target
    tasks:
    - atop:
        command: stop
        labels: [ CPU, PRC, PRM ]

aggregation:
  -
    update:
      query:
        { task: sysbench_oltp }
      values:
        pipeline:
        - { $match: { task: atop, status: OK, label: PRC, name: mysqld }}
        - { $group: { _id: null, mysqld_sys: { $avg: "$sys" }, mysqld_user: { $avg: "$user" }, mysqld_total: { $avg: { $add: [ "$sys", "$user" ] }} }}

report:
  template: sysbench.rst
