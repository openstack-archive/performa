title: Sysbench DB

description:
  This scenario uses sysbench to execute DB test plan.

parameters:
  tester_hosts: List of hosts were omsimulator will be executed
  mysql_hosts: List of hosts were MySQL runs

setup:
  -
    hosts: {{ tester_hosts }}
    tasks:
    - name: installing sysbench
      apt: name=sysbench
      become: yes
  -
    hosts: {{ mysql_hosts }}
    tasks:
    - apt: name=atop
      become: yes
    - apt: name=daemon
      become: yes

execution:
  -
    hosts: {{ mysql_hosts }}
    tasks:
    - atop: command=start
  -
    hosts: {{ tester_hosts }}
    matrix:
      threads: [ 10, 20, 50, 70, 100, 150, 200, 300 ]
    tasks:
    - sysbench_oltp:
        duration: 60
        mysql_host: localhost
        mysql_db: sbtest
  -
    hosts: {{ mysql_hosts }}
    tasks:
    - atop:
        command: stop
        labels: [ PRC ]

aggregation:
  -
    update:
      query:
        { task: sysbench_oltp }
      values:
        pipeline:
        - { $match: { task: atop, status: OK, label: PRC, name: mysqld }}
        - { $group: { _id: null, mysqld_sys: { $avg: "$sys" }, mysqld_user: { $avg: "$user" }, mysqld_total: { $avg: { $add: [ "$sys", "$user" ] }} }}

report:
  template: sysbench.rst
